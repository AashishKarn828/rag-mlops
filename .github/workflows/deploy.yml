name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ec2-user

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # - name: Configure SSH
      #   run: |
      #     mkdir -p ~/.ssh
      #     echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
      #     chmod 600 ~/.ssh/id_rsa
      #     ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>&1 || echo "ssh-keyscan failed"
      
      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "bash -s" << EOF
            set -e
            
            # Setup app directory if it doesn't exist
            if [ ! -d "/opt/rag-app/.git" ]; then
              echo "üîß First-time setup..."
              sudo mkdir -p /opt/rag-app
              sudo chown ec2-user:ec2-user /opt/rag-app
              cd /opt/rag-app
              git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git .
            else
              echo "üì• Pulling latest code..."
              cd /opt/rag-app
              git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
              git pull origin main
            fi
            
            cd /opt/rag-app/infrastructure
            
            # Install docker-compose if not present
            if ! command -v docker-compose &> /dev/null; then
              echo "üì¶ Installing docker-compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            echo "üõë Stopping containers..."
            docker-compose down || true
            
            echo "üßπ Cleaning up..."
            docker system prune -f
            
            echo "üöÄ Starting services..."
            DOCKER_BUILDKIT=0 COMPOSE_DOCKER_CLI_BUILD=0 docker-compose up -d --build
            
            echo "‚è≥ Waiting for services..."
            sleep 60
            
            echo "‚úÖ Deployment complete!"
            docker-compose ps
          EOF
      
      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "bash -s" << EOF
            echo "üîç Checking services..."
            curl -f http://localhost:8000/health || echo "‚ö†Ô∏è Backend health check failed"
            curl -f http://localhost:8501 || echo "‚ö†Ô∏è Frontend check failed"
            echo "‚úÖ Verification complete!"
          EOF
      
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa