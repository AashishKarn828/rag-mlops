name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ec2-user

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          # Preserve line breaks in private key
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "bash -s" << 'EOF'
set -e

APP_DIR=/opt/rag-app

# Ensure app directory exists
if [ ! -d "$APP_DIR/.git" ]; then
  echo "ğŸ”§ First-time setup..."
  sudo mkdir -p $APP_DIR
  sudo chown ec2-user:ec2-user $APP_DIR
  cd $APP_DIR
  git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git .
else
  echo "ğŸ“¥ Pulling latest code..."
  cd $APP_DIR
  git fetch origin
  git reset --hard origin/main
fi

cd $APP_DIR/infrastructure

# Install docker-compose if missing
if ! command -v docker-compose &> /dev/null; then
  echo "ğŸ“¦ Installing docker-compose..."
  sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  sudo chmod +x /usr/local/bin/docker-compose
fi

echo "ğŸ›‘ Stopping containers..."
docker-compose down || true

echo "ğŸ§¹ Cleaning up Docker..."
docker system prune -af
docker builder prune -af

echo "ğŸš€ Building and starting services..."
docker-compose build --no-cache
docker-compose up -d

echo "â³ Waiting for services to stabilize..."
sleep 60

echo "âœ… Deployment complete!"
docker-compose ps
EOF

      - name: Verify Deployment
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} "bash -s" << 'EOF'
echo "ğŸ” Checking backend..."
curl -f http://localhost:8000/health || echo "âš ï¸ Backend health check failed"

echo "ğŸ” Checking frontend..."
curl -f http://localhost:8501 || echo "âš ï¸ Frontend check failed"

echo "âœ… Verification complete!"
EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/id_rsa
